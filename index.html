<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase Table Viewer</title>
  <link rel="icon" href="data:," />
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; }
    .loading { display: none; font-style: italic; color: gray; }
    .sticky-col { position: sticky; left: 0; background: white; z-index: 1; }
    .search-row, .pagination-controls, .filter-controls { margin-bottom: 10px; }
    table { width: 100%; overflow-x: auto; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ddd; }
    .sticky-header th { position: sticky; top: 0; background: white; z-index: 2; }
    .hidden { display: none; }
  </style>
  <script>
    window.SUPABASE_CONFIG = {
      url: 'https://kntomoredgduvwbovgpx.supabase.co',
      key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtudG9tb3JlZGdkdXZ3Ym92Z3B4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MzI0NzcsImV4cCI6MjA3MDIwODQ3N30.Ei7vJ8RQCiz7KPXis6He8dVzL91Euocxzxzg1ptg1_U'
    };
  </script>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4">TKGTPG Table (Supabase)</h1>

    <div class="search-row">
      <input id="searchInput" type="text" class="form-control" placeholder="Search anything...">
    </div>

    <div class="filter-controls d-flex gap-2">
      <select id="filterSatdik" class="form-select w-auto">
        <option value="">All SATDIK</option>
      </select>
      <select id="filterTriwulan" class="form-select w-auto">
        <option value="">All TRIWULAN</option>
      </select>
    </div>

    <div class="loading" id="loadingSpinner">Loading...</div>

    <div class="table-responsive">
      <table id="dataTable">
        <thead class="sticky-header">
          <tr id="tableHeader"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="pagination-controls d-flex justify-content-between align-items-center mt-3">
      <div>
        <button class="btn btn-sm btn-outline" id="prevPage">&lt;</button>
        <span id="pageIndicator">Page 1</span>
        <button class="btn btn-sm btn-outline" id="nextPage">&gt;</button>
      </div>
      <div>
        <label>Go to page:</label>
        <input id="gotoPage" type="number" min="1" class="form-control form-control-sm d-inline-block" style="width: 60px;">
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const { url, key } = window.SUPABASE_CONFIG;
    const supabase = createClient(url, key);

    let page = 1;
    const limit = 20;
    let totalPages = 1;
    let debounceTimer;

    const searchInput = document.getElementById('searchInput');
    const filterSatdik = document.getElementById('filterSatdik');
    const filterTriwulan = document.getElementById('filterTriwulan');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const tableBody = document.getElementById('tableBody');
    const tableHeader = document.getElementById('tableHeader');

    document.getElementById('prevPage').addEventListener('click', () => {
      if (page > 1) {
        page--;
        fetchData();
      }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      if (page < totalPages) {
        page++;
        fetchData();
      }
    });

    document.getElementById('gotoPage').addEventListener('change', e => {
      const val = parseInt(e.target.value);
      if (val >= 1 && val <= totalPages) {
        page = val;
        fetchData();
      }
    });

    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        page = 1;
        fetchData();
      }, 300);
    });

    filterSatdik.addEventListener('change', () => { page = 1; fetchData(); });
    filterTriwulan.addEventListener('change', () => { page = 1; fetchData(); });

    async function fetchData() {
      loadingSpinner.style.display = 'block';
    
      const search = searchInput.value.trim();
      const satdik = filterSatdik.value;
      const triwulan = filterTriwulan.value;
    
      let query = supabase.from('TKGTPG').select('*', { count: 'exact' });
    
      if (search) {
        query = query.or(`NAMA.ilike.%${search}%,NIP.ilike.%${search}%,PEMDA.ilike.%${search}%`);
      }
      if (satdik) query = query.eq('SATDIK', satdik);
      if (triwulan) query = query.eq('TRIWULAN', triwulan);
    
      const start = (page - 1) * limit;
      const end = start + limit - 1;
    
      const { data, count, error } = await query.range(start, end);
    
      loadingSpinner.style.display = 'none';
    
      if (error) return alert('Error fetching data: ' + error.message);
    
      totalPages = Math.ceil(count / limit);
      document.getElementById('pageIndicator').textContent = `Page ${page} of ${totalPages}`;
    
      tableBody.innerHTML = '';
      if (data.length) {
        if (!tableHeader.innerHTML) {
          tableHeader.innerHTML = Object.keys(data[0])
            .map(key => `<th>${key}</th>`).join('');
        }
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = Object.values(row).map(val => `<td>${val ?? ''}</td>`).join('');
          tableBody.appendChild(tr);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="100%">No results found.</td></tr>';
      }
    }


      if (satdik) query = query.eq('SATDIK', satdik);
      if (triwulan) query = query.eq('TRIWULAN', triwulan);

      const start = (page - 1) * limit;
      const end = start + limit - 1;

      const { data, count, error } = await query.range(start, end);

      loadingSpinner.style.display = 'none';
      if (error) return alert('Error fetching data');

      totalPages = Math.ceil(count / limit);
      document.getElementById('pageIndicator').textContent = `Page ${page} of ${totalPages}`;

      tableBody.innerHTML = '';
      if (data.length) {
        if (!tableHeader.innerHTML) {
          tableHeader.innerHTML = Object.keys(data[0])
            .map(key => `<th>${key}</th>`).join('');
        }
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = Object.values(row).map(val => `<td>${val ?? ''}</td>`).join('');
          tableBody.appendChild(tr);
        });
      } else {
        tableBody.innerHTML = '<tr><td colspan="100%">No results found.</td></tr>';
      }
    

    async function populateFilters() {
      const [{ data: satdiks }, { data: triwulans }] = await Promise.all([
        supabase.from('TKGTPG').select('SATDIK').neq('SATDIK', '').order('SATDIK', { ascending: true }),
        supabase.from('TKGTPG').select('TRIWULAN').neq('TRIWULAN', '').order('TRIWULAN', { ascending: true })
      ]);

      const uniqueSatdik = [...new Set(satdiks.map(x => x.SATDIK))];
      uniqueSatdik.forEach(val => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = val;
        filterSatdik.appendChild(opt);
      });

      const uniqueTriwulan = [...new Set(triwulans.map(x => x.TRIWULAN))];
      uniqueTriwulan.forEach(val => {
        const opt = document.createElement('option');
        opt.value = opt.textContent = val;
        filterTriwulan.appendChild(opt);
      });
    }

    await populateFilters();
    await fetchData();
  </script>
</body>
</html>
